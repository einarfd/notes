{% extends "base.html" %}

{% block title %}{{ note.title }} - Notes{% endblock %}

{% block content %}
<div class="card">
    {% if editing %}
    {% if error %}
    <div class="error-message">{{ error }}</div>
    {% endif %}
    <form method="POST" action="/notes/{{ note.path }}">
        <div class="form-group">
            <label for="new_path">Path</label>
            <input type="text" id="new_path" name="new_path" value="{{ note.path }}" required>
        </div>
        <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="title" name="title" value="{{ note.title }}" required>
        </div>
        <div class="form-group">
            <label for="tags">Tags (comma-separated)</label>
            <input type="text" id="tags" name="tags" value="{{ note.tags | join(', ') }}">
        </div>
        <div class="form-group">
            <div class="content-header">
                <label for="content">Content</label>
                <div class="preview-toggle">
                    <button type="button" id="edit-tab" class="tab-btn active" onclick="showEdit()">Edit</button>
                    <button type="button" id="preview-tab" class="tab-btn" onclick="showPreview()">Preview</button>
                </div>
            </div>
            <textarea id="content" name="content">{{ note.content }}</textarea>
            <div id="preview-pane" class="note-content rendered-markdown" style="display: none;"></div>
        </div>
        <div class="actions">
            <button type="submit" class="btn">Save</button>
            <a href="/notes/{{ note.path }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
    <script>
        function showEdit() {
            document.getElementById('content').style.display = 'block';
            document.getElementById('preview-pane').style.display = 'none';
            document.getElementById('edit-tab').classList.add('active');
            document.getElementById('preview-tab').classList.remove('active');
        }
        function showPreview() {
            const content = document.getElementById('content').value;
            const previewPane = document.getElementById('preview-pane');

            // Fetch rendered preview
            fetch('/preview', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'content=' + encodeURIComponent(content)
            })
            .then(response => response.text())
            .then(html => {
                previewPane.innerHTML = html;
                document.getElementById('content').style.display = 'none';
                previewPane.style.display = 'block';
                document.getElementById('edit-tab').classList.remove('active');
                document.getElementById('preview-tab').classList.add('active');
            });
        }
    </script>
    {% else %}
    <h2>{{ note.title }}</h2>
    <div class="metadata">
        <strong>Path:</strong> {{ note.path }}<br>
        <strong>Created:</strong> {{ note.created_at }}<br>
        <strong>Updated:</strong> {{ note.updated_at }}
    </div>
    {% if note.tags %}
    <div style="margin-bottom: 15px;">
        {% for tag in note.tags %}
        <a href="/tags/{{ tag }}" class="tag">{{ tag }}</a>
        {% endfor %}
    </div>
    {% endif %}
    <div class="note-content rendered-markdown">{{ note.content | render_markdown | safe }}</div>
    <div class="actions">
        <a href="/notes/{{ note.path }}/edit" class="btn">Edit</a>
        <a href="/notes/{{ note.path }}/history" class="btn btn-secondary">History</a>
        <form method="POST" action="/notes/{{ note.path }}/delete" style="display:inline;"
              onsubmit="return confirm('Are you sure you want to delete this note?');">
            <button type="submit" class="btn btn-danger">Delete</button>
        </form>
    </div>
    {% endif %}
</div>
{% endblock %}
